var B=Object.create;var x=Object.defineProperty;var N=Object.getOwnPropertyDescriptor;var F=Object.getOwnPropertyNames;var S=Object.getPrototypeOf,D=Object.prototype.hasOwnProperty;var P=(r,t)=>{for(var a in t)x(r,a,{get:t[a],enumerable:!0})},O=(r,t,a,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let p of F(t))!D.call(r,p)&&p!==a&&x(r,p,{get:()=>t[p],enumerable:!(n=N(t,p))||n.enumerable});return r};var W=(r,t,a)=>(a=r!=null?B(S(r)):{},O(t||!r||!r.__esModule?x(a,"default",{value:r,enumerable:!0}):a,r)),z=r=>O(x({},"__esModule",{value:!0}),r);var h=(r,t,a)=>new Promise((n,p)=>{var u=i=>{try{g(a.next(i))}catch(f){p(f)}},d=i=>{try{g(a.throw(i))}catch(f){p(f)}},g=i=>i.done?n(i.value):Promise.resolve(i.value).then(u,d);g((a=a.apply(r,t)).next())});var k={};P(k,{default:()=>M});module.exports=z(k);var w=W(require("sharp")),m={jpeg:"jpeg",jpg:"jpeg",webp:"webp",avif:"avif",png:"png"},A={jpeg:"image/jpeg",webp:"image/webp",avif:"image/avif",png:"image/png"},M=()=>({name:"@exact-realty/esbuild-plugin-responsive-images",setup(r){r.onLoad({filter:/.*/,namespace:"@exact-realty/esbuild-plugin-responsive-images/loader"},t=>h(this,null,function*(){let{path:a,pluginData:n}=t;if(!(n instanceof Object)||!(n.params instanceof URLSearchParams))return{errors:[{text:"Invalid pluginData"}]};let p=n.params.get("inputFormat"),u=n.params.has("outputFormats")?Array.from(new Set(String(n.params.get("outputFormats")).split(",").map(e=>{var s;return(s=m[e.trim()])!=null?s:e}))):[],d=n.params.has("sizes")?Array.from(new Set(String(n.params.get("sizes")).split(",").map(e=>e.trim()))).sort((e,s)=>Number(e.slice(0,-1))-Number(s.slice(0,-1))):[],g=Math.round(Number(n.params.get("displayWidth")))||1024,i=[];p&&!(p in m)&&i.push({text:`Unsupported input format '${p}'. Must be one of ${Object.keys(m).join(", ")}.`}),u.forEach(e=>{e in m||i.push({text:`Unsupported output format '${e}'. Must be one of ${Object.keys(m).join(", ")}.`})}),d.length===0&&i.push({text:"At least one output size must be specified."});let f=d.reduce((e,s)=>/^[0-9]*[1-9][0-9]*w$/.test(s)?e|1:/^([0-9]*[1-9][0-9]*(\.[0-9]*)?|0*\.[0-9]*[1-9][0-9]*)x$/.test(s)?e|2:e|4,0);if((f&3)===3&&i.push({text:"Invalid size description: mixed width descriptors (###w) and pixel density descriptors (###x)"}),(f&4)===4&&i.push({text:"Invalid size description: invalid descriptions. Only width (###w) and pixel density density descriptors (###x) are supported."}),i.length)return{errors:i};let b=(0,w.default)(a),c=yield b.metadata();if(u.length===0)if(c.format&&c.format in m)u.push(c.format);else return{errors:[{text:"No output format specified, and unable to identify format in source image"}]};let $=(yield Promise.all(d.map((e,s)=>h(this,null,function*(){let o=e.endsWith("w")?Number(e.slice(0,-1)):e.endsWith("x")?Math.round(Number(e.slice(0,-1))*g):NaN;if(!Number.isInteger(o))throw new Error("Invalid width");if(c.width!==void 0&&o>=c.width){if(s!==0)return;o=c.width}return[e,yield b.clone().resize({width:o,withoutEnlargement:!0}).toFormat("png").toBuffer({resolveWithObject:!0})]})))).filter(Boolean),y=(yield Promise.all($.flatMap(([e,s])=>u.map(o=>h(this,null,function*(){if(s.info.format===o)return[e,o,s];switch(o){case"jpeg":return[e,o,yield(0,w.default)(s.data).toFormat(o,{mozjpeg:!0}).toBuffer({resolveWithObject:!0})];case"png":case"avif":case"webp":return[e,o,yield(0,w.default)(s.data).toFormat(o).toBuffer({resolveWithObject:!0})]}})))).finally(()=>{$.length=0})).filter(Boolean),l=y.reduce((e,[s,o,v],I)=>(o in e||(e[o]=[]),e[o].push([s,v,I]),e),Object.create(null)),j="png"in l&&"jpeg"in l?l.png[0][1].info.size>l.jpeg[0][1].info.size?"jpeg":"png":"png"in l?"png":"jpeg"in l?"jpeg":"webp"in l?"webp":Object.keys(l)[0];return{contents:`
						${y.map((e,s)=>`import _i${+s}_ from '${Buffer.from(t.path).toString("base64")}.${+s}.${e[0].replace(".","-")}.${e[1]}';`).join("")}

						
						export const src = _i${l[j][0][2]}_;
						export const width = ${+l[j][0][1].info.width};
						export const height = ${+l[j][0][1].info.height};
						export const originalWidth = ${c.width};
						export const originalHeight = ${c.height};
						export const sources = [
							${Object.entries(l).map(([e,s])=>"["+JSON.stringify(A[e!=null?e:e])+","+s.map(([o,,v])=>[`_i${+v}_`,JSON.stringify(" "),JSON.stringify(o)].join("+")).join('+ "," +')+"]").join(",")}
						];`,loader:"js",pluginData:y}})),r.onLoad({filter:/.*/,namespace:"@exact-realty/esbuild-plugin-responsive-images/importer"},t=>{let{pluginData:a}=t;return a instanceof Buffer?{contents:a,loader:"file"}:{errors:[{text:"Invalid plugin data. Expecting Buffer."}]}}),r.onResolve({filter:/^respimg\+file:/},t=>h(this,null,function*(){let{path:a,resolveDir:n}=t,p=new URL(a),u=yield r.resolve(decodeURIComponent(p.pathname),{resolveDir:n});return u.errors.length>0?{errors:u.errors}:{external:!1,namespace:"@exact-realty/esbuild-plugin-responsive-images/loader",path:u.path,suffix:void 0,watchDirs:[],watchFiles:[u.path],pluginData:{params:p.searchParams}}})),r.onResolve({filter:/.*/,namespace:"@exact-realty/esbuild-plugin-responsive-images/loader"},t=>{let{path:a,pluginData:n}=t,[p,u,d,g]=t.path.split("."),i=+u;if(!Array.isArray(n)||!Number.isInteger(i)||i<0||i>n.length||!Array.isArray(n[i])||!(n[i][2]instanceof Object)||!(n[i][2].data instanceof Buffer))return{errors:[{text:`Invalid path or plugin data. Path: ${a}.`}]};let f=Buffer.from(p,"base64").toString(),c=[f.lastIndexOf(".")>0?f.slice(0,f.lastIndexOf(".")):f,d.replace("-","."),g].join(".");return{external:!1,namespace:"@exact-realty/esbuild-plugin-responsive-images/importer",path:c,suffix:void 0,watchDirs:[],watchFiles:[],pluginData:n[i][2].data}})}});0&&(module.exports={});
